# Background Monitoring Design Document

## 概要

Claude Code セッション開始時に自動的にプロジェクト状態を監視し、
Cursor ↔ Claude Code 間の連携をスムーズにする機能。

---

## 制約事項（調査結果より）

| 制約 | 影響 | 対策 |
|-----|------|------|
| Hook タイムアウト 60秒 | 長時間処理は不可 | 軽量スクリプトで即座に完了 |
| 真のバックグラウンド不可 | デーモン化できない | 状態ファイルで疑似的に実現 |
| セッション間で状態消失 | 変数が引き継がれない | JSON 状態ファイルで永続化 |

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    SessionStart Hook                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ session-monitor.sh                                       ││
│  │ - Git 状態チェック                                       ││
│  │ - Plans.md 変更検出                                      ││
│  │ - 状態ファイル生成 (.claude/state/session.json)          ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   PostToolUse Hook                           │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ track-changes.sh (matcher: Write|Edit)                   ││
│  │ - 変更されたファイルを記録                               ││
│  │ - Plans.md 更新を検出                                    ││
│  │ - 状態ファイル更新                                       ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Stop Hook                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ session-summary.sh                                       ││
│  │ - セッションサマリー生成                                 ││
│  │ - 次回セッションへの引き継ぎ情報記録                     ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

---

## 状態ファイル構造

### `.claude/state/session.json`

```json
{
  "session_id": "abc123",
  "started_at": "2025-12-12T10:00:00Z",
  "cwd": "/path/to/project",
  "git": {
    "branch": "main",
    "uncommitted_changes": 3,
    "last_commit": "abc1234"
  },
  "plans": {
    "last_modified": "2025-12-12T09:30:00Z",
    "wip_tasks": 2,
    "pending_tasks": 5
  },
  "changes_this_session": [
    {
      "file": "src/index.ts",
      "action": "edit",
      "timestamp": "2025-12-12T10:05:00Z"
    }
  ]
}
```

---

## Phase 1 実装範囲

### 1.1 SessionStart: session-monitor.sh

**目的**: セッション開始時にプロジェクト状態を収集・表示

**出力例**:
```
📊 セッション開始 - プロジェクト状態
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📂 プロジェクト: my-project
🔀 ブランチ: feature/new-feature
📝 未コミット: 3ファイル
📋 Plans.md: WIP 2件 / TODO 5件
⏰ 前回セッション: 2時間前
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 1.2 PostToolUse: track-changes.sh

**目的**: ファイル変更を追跡し、重要な変更を検出

**検出対象**:
- Plans.md の更新（マーカー変更）
- CLAUDE.md / AGENTS.md の更新
- テストファイルの追加・変更

### 1.3 Stop: session-summary.sh

**目的**: セッション終了時にサマリーを生成

**出力例**:
```
📊 セッションサマリー
━━━━━━━━━━━━━━━━━━━━━━━
✅ 完了タスク: 3件
📝 変更ファイル: 8件
💾 コミット: 2件
⏱️ セッション時間: 45分
━━━━━━━━━━━━━━━━━━━━━━━
```

---

## Phase 2 構想（将来）

- 並列タスク実行（複数 Task を同時に走らせる）
- Cursor への自動通知（Plans.md 変更時）
- ファイル監視による自動テスト実行

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `hooks/hooks.json` | フック定義 |
| `scripts/session-monitor.sh` | セッション開始監視 |
| `scripts/track-changes.sh` | 変更追跡 |
| `scripts/session-summary.sh` | セッション終了サマリー |
