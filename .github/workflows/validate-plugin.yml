name: validate-plugin

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check version bump (warn)
        id: version_bump
        continue-on-error: true
        run: |
          bash ./scripts/ci/check-version-bump.sh

      - name: Auto bump patch version & push (when missing)
        if: steps.version_bump.outcome == 'failure' && github.event_name == 'push' && github.actor != 'github-actions[bot]'
        run: |
          echo "::warning title=Version bump missing::Code changes detected but VERSION was not bumped. Auto-bumping patch version and pushing."

          bash ./scripts/sync-version.sh bump

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          NEW_VERSION="$(cat VERSION | tr -d '[:space:]')"

          # Keep marketplace metadata in sync if present
          if [ -f .claude-plugin/marketplace.json ]; then
            node -e "const fs=require('fs');const p='.claude-plugin/marketplace.json';const v=process.env.NEW_VERSION;const j=JSON.parse(fs.readFileSync(p,'utf8'));if(j.metadata){j.metadata.version=v;}if(Array.isArray(j.plugins)){j.plugins=j.plugins.map(pl=>({...pl,version:v}));}fs.writeFileSync(p, JSON.stringify(j,null,2)+'\\n');"
          fi

          # Keep README badge in sync if present
          if [ -f README.md ]; then
            perl -pi -e "s/\\[!\\[Version: \\d+\\.\\d+\\.\\d+\\]\\(https:\\/\\/img\\.shields\\.io\\/badge\\/version-\\d+\\.\\d+\\.\\d+-blue\\.svg\\)\\]\\(VERSION\\)/[![Version: ${NEW_VERSION}](https:\\/\\/img.shields.io\\/badge\\/version-${NEW_VERSION}-blue.svg)](VERSION)/" README.md || true
          fi

          git add VERSION .claude-plugin/plugin.json .claude-plugin/marketplace.json README.md || true
          git commit -m "chore: bump version to ${NEW_VERSION}" || echo "No version changes to commit"
          git push

      - name: Validate plugin structure
        run: |
          bash ./tests/validate-plugin.sh

      - name: Check consistency (templates/refs/version/hooks)
        run: |
          bash ./scripts/ci/check-consistency.sh


